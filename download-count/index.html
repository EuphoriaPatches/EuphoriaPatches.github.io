<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Basic Page Needs
    ================================================== -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="canonical" href="https://www.euphoriapatches.com/download-count/"/>

    <title>Download Count | Euphoria Patches</title>

    <meta name="description" content="Total Download Counter">
    <meta name="author" content="">
    <meta name="keywords" content="">

    <!-- Mobile Specific Metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=5.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,600,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">

    <!-- Favicon
    ================================================== -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/EuphoriaPatchesLogo_180x.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/EuphoriaPatchesLogo_16x.png">

    <!-- Stylesheets
    ================================================== -->
    <!-- Bootstrap core CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/assets/css/style.min.css" rel="stylesheet">
    <link href="/assets/css/responsive.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3CGSG92RGD"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-3CGSG92RGD');
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
<div id="download-counter-all-page">
    <header id="masthead" class="site-header site-header-white">
        <nav id="primary-navigation" class="site-navigation">
            <div class="container">

                <div class="navbar-header">
                   
                    <a href="/" class="site-title"><span>Euphoria</span> Patches</a>

                </div><!-- /.navbar-header -->

                <div class="collapse navbar-collapse" id="agency-navbar-collapse">

                    <ul class="nav navbar-nav navbar-right">

                        <li><a href="/">Home</a></li>
                        <li><a href="/download">Download</a></li>
                        <li><a href="/support">Preview Versions</a></li>
                        <li><a href="/gallery">Gallery</a></li>
                        <li><a href="/changelogs">Changelogs</a></li>

                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Information<i class="fa fa-caret-down hidden-xs" aria-hidden="true"></i></a>
                            <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
                              <li><a href="/contact">Contact</a></li>
                              <li><a href="/faq">FAQ</a></li>
                              <li><a href="/how-to-install">How To Install</a></li>
                              <li><a href="/credits">Credits</a></li>
                              <li><a href="/download-count/" style="color: var(--ThemeColor);">Download Count</a></li>
                              <li><a href="/privacy-policy">Privacy Policy</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>   
        </nav><!-- /.site-navigation -->
    </header><!-- /#mastheaed -->

    <main id="main" class="site-main download-page-main">
        <section class="site-section gradient-bg">
            <div class="download-counter-page">
                <h2>Total Downloads:</h2>
                <div class="total-download-number">
                    <div class="typed-out" id="typed-out">
                        <h1 id="download-counter">&nbsp;</h1>
                    </div>
                    <div id="download-details" class="download-details">
                        <div id="daily-avg">&nbsp;</div>
                        <div id="modrinth-downloads"></div>
                        <div id="curseforge-downloads"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>


    <footer id="colophon" class="site-footer"></footer>
        <div class="copyright">
            <div class="container">
                <div class="row">
                    <div class="col-xs-8">
                        <div class="social-links">
                            <a class="discord-bg" href="/discord" target="_blank" alt="Discord Invite"></a>
                            <a class="patreon-bg" href="/support" target="_blank" alt="Patreon Link"></a>
                            <a class="github-bg" href="/github" target="_blank" alt="Github Link"></a>
                            <a class="contact-bg" href="/contact" target="_blank" alt="Contact Page Link">Contact</a>
                        </div><!-- /.social-links -->
                    </div>
                    <div class="col-xs-4 site-title">
                        <div class="text-right">
                            <a href="/">Euphoria Patches</a>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.copyright -->
    </footer><!-- /#footer -->
</div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/bootstrap-select.min.js"></script>
    <script src="/assets/js/jquery.slicknav.min.js"></script>
    <script src="/assets/js/jquery.countTo.min.js"></script>
    <script src="/assets/js/jquery.shuffle.min.js"></script>
    <script src="/assets/js/script.js"></script>

    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBheyXP71wW38Pr1Pz7td5fA1ceNF7I-4U",
            authDomain: "ep-website-backend.firebaseapp.com",
            databaseURL: "https://ep-website-backend-default-rtdb.firebaseio.com",
            projectId: "ep-website-backend",
            storageBucket: "ep-website-backend.appspot.com",
            messagingSenderId: "527249989649",
            appId: "1:527249989649:web:7c4913be47d320cbb891b0",
            measurementId: "G-W72RZF1WBJ"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
    
        // Fetch Modrinth Downloads
        async function fetchModrinthDownloads(projectId) {
            try {
                const response = await fetch(`https://api.modrinth.com/v2/project/${projectId}`);
                const data = await response.json();
                return data.downloads || 0;
            } catch (error) {
                console.error('Error fetching Modrinth downloads:', error);
                return 0;
            }
        }
    
        // Fetch CurseForge Downloads
        async function fetchCurseforgeDownloads(projectId) {
            try {
                const response = await fetch(`https://api.curseforge.com/v1/mods/${projectId}`, {
                    headers: {
                        'Accept': 'application/json',
                        'x-api-key': '$2a$10$izPaCsTGxUGv.3h62ZixYelNErqfLizoCjVJphyCNFs00riMLc5wK' // Replace with your actual API key
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Curseforge API request failed');
                }
                
                const data = await response.json();
                return data.data.downloadCount || 0;
            } catch (error) {
                console.error('Error fetching Curseforge downloads:', error);
                return 0;
            }
        }
    
        // Update Download Counter
        // Update Download Counter
        async function updateDownloadCounter() {
            const modrinthProjectId = '4H6sumDB';
            const curseforgeProjectId = '915902';

            try {
                const modrinthDownloads = await fetchModrinthDownloads(modrinthProjectId);
                const curseforgeDownloads = await fetchCurseforgeDownloads(curseforgeProjectId);
                const totalDownloads = modrinthDownloads + curseforgeDownloads;

                console.log(`Modrinth Downloads: ${modrinthDownloads}`);
                console.log(`Curseforge Downloads: ${curseforgeDownloads}`);
                console.log(`Total Downloads: ${totalDownloads}`);

                // Update DOM
                const downloadCounter = document.getElementById('download-counter');
                downloadCounter.innerText = totalDownloads.toLocaleString();

                const typedOutElement = document.getElementById('typed-out');
                typedOutElement.classList.add('animate');

                const currentTimestamp = Date.now();
                const dbRef = ref(database, 'totals');

                // Fetch previous data from the database
                const snapshot = await get(dbRef);
                const previousData = snapshot.exists() ? snapshot.val() : { 
                    timestamp: currentTimestamp, 
                    totalDownloads: totalDownloads, 
                    dailyAverageSum: 0, 
                    dailyAverage : 0,
                    totalDaysSinceStart: 0
                };

                console.log('Previous Data:', previousData);
                const readableTimestamp = new Date(previousData.timestamp).toLocaleString();
                console.log('Previous Timestamp (Readable):', readableTimestamp);

                const daysPassed = (currentTimestamp - previousData.timestamp) / (1000 * 60 * 60 * 24);
                let dailyAverageSum = previousData.dailyAverageSum; 
                let dailyAverage = previousData.dailyAverage;
                let newTotalDownloads = previousData.totalDownloads; 
                let newTimestamp = previousData.timestamp; 
                let totalDaysSinceStart = previousData.totalDaysSinceStart;

                // Update only if at least 1 day has passed
                if (daysPassed >= 1) {
                    const wholeDaysPassed = Math.floor(daysPassed); 
                    const downloadDifference = totalDownloads - previousData.totalDownloads;

                    dailyAverageSum += downloadDifference;
                    totalDaysSinceStart += wholeDaysPassed;

                    // Calculate the new cumulative daily average
                    dailyAverage = Math.round(dailyAverageSum / totalDaysSinceStart);

                    // Update the historical data
                    newTotalDownloads = totalDownloads;
                    newTimestamp = currentTimestamp;
                }

                if (newTimestamp == previousData.timestamp) {
                    console.log('A day has not yet passed - no new data to update');
                } else {
                    console.log('Data being written to the database:', {
                    timestamp: newTimestamp,
                    totalDownloads: newTotalDownloads,
                    dailyAverageSum: dailyAverageSum,
                    dailyAverage: dailyAverage,
                    totalDaysSinceStart: totalDaysSinceStart
                });
                }

                // Save the updated data to the database
                await set(dbRef, {
                    timestamp: newTimestamp,
                    totalDownloads: newTotalDownloads,
                    dailyAverageSum: dailyAverageSum,
                    dailyAverage: dailyAverage,
                    totalDaysSinceStart: totalDaysSinceStart
                });

                // Update additional DOM elements
                const dailyAvgElement = document.getElementById('daily-avg');
                const modrinthDownloadsElement = document.getElementById('modrinth-downloads');
                const curseforgeDownloadsElement = document.getElementById('curseforge-downloads');

                dailyAvgElement.innerText = `Daily Average: ${dailyAverage.toLocaleString()} downloads`;
                modrinthDownloadsElement.innerText = `Modrinth Downloads: ${modrinthDownloads.toLocaleString()}`;
                curseforgeDownloadsElement.innerText = `CurseForge Downloads: ${curseforgeDownloads.toLocaleString()}`;

                // dailyAvgElement.setAttribute('data-tooltip', "Yesterday's Downloads: " + dailyAverage.toLocaleString());

                dailyAvgElement.style.transition = "opacity 0.2s ease"; // Add transition to the element

                dailyAvgElement.addEventListener('mouseenter', () => {
                    dailyAvgElement.style.opacity = "0"; // Fade out
                    setTimeout(() => {
                        dailyAvgElement.innerText = "Yesterday's Downloads: " + dailyAverage.toLocaleString(); // Change text after fade-out
                        dailyAvgElement.style.opacity = "1"; // Fade back in
                    }, 200); // Match the transition duration
                });

                dailyAvgElement.addEventListener('mouseleave', () => {
                    dailyAvgElement.style.opacity = "0"; // Fade out
                    setTimeout(() => {
                        dailyAvgElement.innerText = `Daily Average: ${dailyAverage.toLocaleString()} downloads`;
                        dailyAvgElement.style.opacity = "1"; // Fade back in
                    }, 200); // Match the transition duration
                });
            } catch (error) {
                console.error('Error updating download counter:', error);
                document.getElementById('download-counter').innerText = 'Error';
            }
        }

        // Call the function
        updateDownloadCounter();
    </script>
    

</body>
</html>
